# clojure/ — Portable Clojure Core

Self-hosting Clojure. Three layers: protocols define the interface, host bridges
to platforms, types provide constructors. Everything else builds on these.

## Architecture

```
protocols.cljc   25 protocols (ISeq, IMap, IFn, ICounted, ...)
host.cljc        1 protocol — everything a platform must provide
types.cljc       constructors bridging core <-> host
system.cljc      getenv, properties, time
```

Platform implementations (PHP, JS, C, etc.) satisfy `Host`. That's the contract.

## Core

| File | Lines | Description |
|------|-------|-------------|
| core.cljc | 8229 | Upstream JVM original (Rich Hickey) |
| pcore.cljc | 8046 | Portable full core — generated by `script/portabilize_v3.clj` (rewrite-clj) |
| pmcore.cljc | 2001 | Portable minimal core — hand-written subset |

`pcore.cljc` replaces all `clojure.lang.*` / `java.*` with `p/` `h/` `t/` calls.
Structure, comments, and syntax-quote templates are preserved from upstream.

## Ports (upstream adapted to host abstraction)

| File | Wraps |
|------|-------|
| concurrent.cljc | h/-conc-thread, h/-conc-sleep |
| io.cljc | h/-io-slurp, h/-io-spit, h/-io-exists? |
| math.cljc | h/-math-floor, h/-math-ceil, h/-math-round |
| process.cljc | h/-proc-exec |
| regex.cljc | h/-re-pattern, h/-re-matches |
| time.cljc | h/-time-now, h/-time-instant-ms |
| uri.cljc | h/-uri-parse |
| uuid.cljc | h/-uuid-random, h/-uuid-from-string |

## Original (genera-specific)

async, bench, browse, doc, http, json, parity, shell, sql, stream

## JVM copies (not yet ported)

JVM originals live in `C:\Proj\genera\ref\clojure\src\clj\clojure\`.
Port with `portabilize_v3.clj` or hand-edit. Pattern: replace `clojure.lang.*` /
`java.*` calls with `(h/-operation (h/host) args...)`, keep algorithm logic intact.

### Top-level files

| File | Lines | JVM Refs | Effort |
|------|-------|----------|--------|
| zip.cljc | 318 | 0 | Trivial — copy as-is |
| set.cljc | 181 | 0 | Trivial — copy as-is |
| csv.cljc | 24 | 0 | Stub only |
| template.cljc | 55 | 0 | Trivial (needs walk) |
| walk.cljc | 131 | 3 | Low — 3 type checks (IMapEntry, IRecord, MapEntry/create) |
| stacktrace.cljc | 87 | 0 | Low — platform methods (.getCause, .getStackTrace) |
| string.cljc | 377 | 4 | Low — regex import + LazilyPersistentVector in split |
| data.cljc | 143 | 6 | Low — protocol extends on java.util.{Set,List,Map} |
| datafy.cljc | 62 | 4 | Low-Med — protocol extends for IRef, Namespace, Class |
| edn.cljc | 45 | 3 | Medium — delegates parsing to clojure.lang.EdnReader |
| xml.cljc | 150 | 3+ | Medium — SAX parsing, javax.xml.parsers |
| repl.cljc | 289 | 7 | Medium — IO readers, Compiler/demunge, reflection |
| test.cljc | 830 | 3 | Medium — large but mostly pure DSL |
| pprint.cljc | 51 | 0 | Loader — see submodules below |
| main.cljc | 676 | 20 | High — entry point, Compiler, classloader, threads |

### Submodules (missing from repo, in JVM reference)

**pprint/** — 3,658 lines:

| File | Lines | JVM Refs | Assessment |
|------|-------|----------|------------|
| print_table.clj | 35 | 0 | Pure |
| utilities.clj | 114 | 1 | Pure |
| column_writer.clj | 83 | 3 | Light — java.io.Writer |
| pretty_writer.clj | 506 | 3 | Light — writer wrapping |
| pprint_base.clj | 403 | 10 | Light |
| cl_format.clj | 1,949 | 25 | Moderate — CL FORMAT, proxy on Writer |
| dispatch.clj | 568 | 39 | Moderate — multimethod dispatch on clojure.lang types |

**test/** — 318 lines:

| File | Lines | JVM Refs | Assessment |
|------|-------|----------|------------|
| tap.clj | 123 | 0 | Pure |
| junit.clj | 195 | 1 | Pure |

**repl/** — 96 lines:

| File | Lines | JVM Refs | Assessment |
|------|-------|----------|------------|
| deps.clj | 96 | 5 | Light |

**core/** — 876 lines:

| File | Lines | JVM Refs | Assessment |
|------|-------|----------|------------|
| protocols.clj | 201 | 8 | Light — extend-protocol on IReduceInit, Iterable |
| reducers.clj | 334 | 9 | Light — fold/reduce on JVM collection types |
| server.clj | 341 | 7 | Light — ServerSocket, Thread, ReentrantLock |

### Compression estimates

~16% docstrings, ~20% JVM boilerplate (imports, type hints, proxy/reify),
~10% droppable features. Precedent: core.cljc 8229 → pmcore.cljc 2001 (4:1).

| File | Original | Compressed | Notes |
|------|----------|------------|-------|
| zip | 318 | 260 | Pure algorithm (74% essential) |
| set | 181 | 140 | Pure algorithm (70%) |
| walk | 131 | 110 | 3 type checks → p/* calls |
| data | 143 | 90 | Diff logic pure, swap extend targets |
| datafy | 62 | 50 | Drop Class/Namespace reflection |
| stacktrace | 87 | 70 | Abstract .getCause/.getStackTrace |
| string | 377 | 180 | 39 fns → ~15 core ops, drop reflection |
| edn | 45 | 35 | Thin wrapper, swap parser |
| template | 55 | 45 | Pure (needs walk) |
| csv | 24 | 20 | Stub |
| test | 830 | 420 | Keep is/deftest/testing DSL, drop reporting UI |
| test/tap | 123 | 0 | Drop — TAP output format |
| test/junit | 195 | 0 | Drop — JUnit XML |
| repl | 289 | 140 | Keep doc/source/apropos, drop Ctrl-C/IO readers |
| repl/deps | 96 | 0 | Drop — JVM classpath deps |
| reducers | 334 | 160 | Drop ForkJoinPool, keep fold/reduce protocols |
| server | 341 | 180 | Drop sockets, keep prepl protocol |
| main | 676 | 360 | Drop ClassLoader/thread-local, keep REPL+script |
| pprint | 51 | 30 | Loader (trimmed) |
| pprint/print_table | 35 | 30 | Pure |
| pprint/utilities | 114 | 80 | Pure |
| pprint/column_writer | 83 | 50 | Writer → host buffer |
| pprint/pretty_writer | 506 | 230 | Drop proxy, use host write buffer |
| pprint/pprint_base | 403 | 200 | Drop binding macros |
| pprint/cl_format | 1,949 | 900 | Drop roman/english cardinal (~470 lines) |
| pprint/dispatch | 568 | 280 | Drop Java class introspection |
| core/protocols | 201 | 120 | Swap JVM types for portable |
| core/reducers | 334 | 160 | (same as reducers above) |

### Totals

| Category | Files | Original | Compressed |
|----------|-------|----------|------------|
| Top-level | 15 | ~3,418 | ~1,540 |
| pprint/ | 7 | 3,658 | ~1,800 |
| test/ | 2 | 318 | 0 (drop) |
| repl/ | 1 | 96 | 0 (drop) |
| core/ | 3 | 876 | ~460 |
| **Total** | **28** | **~8,366** | **~3,800** |

**8,366 → ~3,800 lines (2.2:1 ratio).** The big wins: pprint drops ~50%
(roman numerals, english cardinals, proxy boilerplate), test drops reporting
backends, docstrings/comments are uniform ~16% across all files.

### Porting order

1. **Trivial** — zip, set, csv, template (copy or near-copy)
2. **Low** — walk → stacktrace, string, data (< 10 edits each)
3. **Medium** — datafy, edn, test (DSL only), reducers
4. **Infrastructure** — repl, pprint (1,800 compressed — still half the work), core/server
5. **Deep** — main (360 compressed, compilation pipeline)
6. **Drop** — test/junit, test/tap, repl/deps (JVM-only concerns)
