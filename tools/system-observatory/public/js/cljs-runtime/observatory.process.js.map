{"version":3,"sources":["observatory/process.cljc"],"mappings":";AAkBA,mCAAA,mFAAA,qDAAA,2DAAA,8DAAA,4DAAA,hWAAKA;AAGL;;;mCAAA,mFAAA,mDAAA,mFAAA,sEAAA,4DAAA,mFAAA,oEAAA,4DAAA,mFAAA,iEAAA,4DAAA,mFAAA,iEAAA,mFAAA,qDAAA,qDAAA,wDAAA,2DAAA,gEAAA,mEAAA,kEAAA,mFAAA,qDAAA,mFAAA,qDAAA,qDAAA,qDAAA,qDAAA,uDAAA,kEAAA,yEAAA,mFAAA,kEAAA,2CAAA,6DAAA,aAAA,kEAAA,mFAAA,wEAAA,2CAAA,6DAAA,aAAA,vnFAAKC;AAWL,8BAAA,oFAAA,mDAAA,mFAAA,mDAAA,4DAAA,mFAAA,oDAAA,2CAAA,6DAAA,aAAA,4DAAA,mFAAA,qDAAA,kEAAA,mFAAA,2DAAA,2CAAA,6DAAA,aAAA,kEAAA,mFAAA,0DAAA,2CAAA,6DAAA,aAAA,kEAAA,mFAAA,iGAAA,mFAAA,qDAAA,2CAAA,6DAAA,aAAA,kEAAA,mFAAA,kEAAA,gEAAA,mFAAA,sEAAA,4DAAA,mFAAA,4DAAA,4DAAA,mFAAA,4DAAA,2CAAA,6DAAA,aAAA,4DAAA,mFAAA,gEAAA,2CAAA,6DAAA,aAAA,kEAAA,mFAAA,0EAAA,2CAAA,6DAAA,aAAA,mFAAA,zkHAAKC,6nDAOMF,qgEAOmCC;AAM9C,AAAA;;;mCAAA,2CAAAE,9EAAMM;AAAN,AAAA,IAAAL,qBAAA;AAAA,AAAA,IAAAC,0BAAA,AAAA;AAAA,AAAA,IAAAC,wBAAA;;AAAA,AAAA,GAAA,CAAAA,wBAAAD;AAAA,AAAA,AAAAD,wBAAA,CAAA,UAAAE;;AAAA,eAAA,CAAAA,wBAAA;;;;AAAA;;;;AAAA,IAAAC,uBAAA,EAAA,CAAA,MAAA,AAAAH,4BAAA,AAAA,KAAAI,qBAAA,AAAAJ,yBAAA,KAAA,IAAA,OAAA;AAAA,AAAA,OAAAK,sEAAA,CAAA,UAAA,MAAA,CAAA,UAAA,MAAAF;;;AAAA,AAAA,CAAA,wEAAA,oBAAAG,5FAAMD,mFAEHW,IAAIC;AAFP,AAAA,IAAAV,aAAAD;IAAAC,iBAAA,AAAAC,4BAAAD;cAAA,AAAAE,4CAAAF,eAAA,rEAGuDmB;WAHvD,AAAAjB,4CAAAF,eAAA,lEAEkDe;mBAFlD,AAAAb,4CAAAF,eAAA,sEAAA,hJAGkCiB;kBAHlC,AAAAf,4CAAAF,eAAA,kEAAA,3IAGsBgB;eAHtB,AAAAd,4CAAAF,eAAA,tEAE2BY;YAF3B,AAAAV,4CAAAF,eAAA,wDAAA,3HAE4Cc;WAF5C,AAAAZ,4CAAAF,eAAA,lEAEsBW;cAFtB,AAAAT,4CAAAF,eAAA,4DAAA,jIAG+CkB;cAH/C,AAAAhB,4CAAAF,eAAA,rEAEoCa;AAFpC,AAAA,+CAAA,0EAAA,sEAAA,kEAAA,2DAAA,qDAAA,wDAAA,oDAAA,4DAAA,mDAAA,0DAAA,4DAAA,uDAAA,2FAQQJ,bACCE,XACAD,TACIE,qCACDC,vBACFC,uCACDC,jEACOC,bACCC,kDACLC,oBACAC;;;AAlBZ,CAAA,2DAAA,3DAAMrB;;AAAN;AAAA,CAAA,qDAAA,WAAAK,hEAAML;AAAN,AAAA,IAAAM,WAAA,AAAAC,gBAAAF;IAAAA,eAAA,AAAAG,eAAAH;IAAAI,WAAA,AAAAF,gBAAAF;IAAAA,eAAA,AAAAG,eAAAH;AAAA,AAAA,IAAAK,qBAAA;AAAA,AAAA,OAAAA,wDAAAJ,SAAAG,SAAAJ;;;AAAA,AAqBA;;;yCAAA,zCAAMiB,0FAEHC,cAAcC,WAAWC,KAAKC;AAFjC,AAAA,kDAAA,oFAAA,iGAAA,4EAAA,0DAAA,rPAGkBH,kFACF,CAAGA,gBAAcC,6EAClBA,gEACNC,sEACMC;;AAMf;;;uCAAA,vCAAMC,sFAEHC;AAFH,AAGE,uDAAA,hDAACC,kHAAqBC,eAAEF;;AAE1B;;;0CAAA,1CAAMG,4FAEHH;AAFH,AAGE,uDAAA,hDAACC,sHAAsBC,eAAEF;;AAE3B;;;;mCAAA,nCAAMI,8EAGHJ;AAHH,AAIE,IAAMK,SAAO,6CAAA,7CAACC,gFAAQ,AAACC,4CAAI,6CAAA,7CAACC,gGAAUC,oBAAUT;IAC1CU,eAAa,mBAAA,nBAACC,uEAAeX;AADnC,AAEE,iBAAA,wDAAqBY;AAArB,AAAA,kDAAA,gEAAA,LACoBA,kEACC,AAACC,6CAAKC,8CAAW,gJAAA,hJAACtC,4CAAIkC,aAAa,AAAA,iFAAME;;AAF9D,+DAIO,+CAAA,WAAAG,1DAACC,/DACD,OAACH,6CAAKC;AADN,AAAS,mKAAA,3JAAM,AAACtC,4CAAI6B,OAAO,AAAA,kFAAAU;GAD3Bf;;AAIX;;;mCAAA,nCAAMiB,8EAEHC;AAFH,AAGE,mBAAA,0DAAAC,SAAkDI;AAAlD,AAAA,IAAAH,aAAAD;IAAAC,iBAAA,AAAA7C,4BAAA6C;kBAAA,AAAA5C,4CAAA4C,eAAA,zEAA+BC;eAA/B,AAAA7C,4CAAA4C,eAAA,tEAAuCE;AAAvC,AACU,OAACE,eAAK,0DAAA,1DAACC,8CAAMJ,mEAAeE,OACtB,sDAAA,WAAAG,jEAACC;AAAD,AAAS,uDAAAD,hDAACE,iEAAe,SAAA,RAAKL;qDAAQD;;AAFtD,AAGE,6DAAA,WAAAO,jEAACF;AAAD,AAAS,oBAAAE,iBAAA,9BAACD;qDAAkBV;;AAMhC;;;qCAAA,rCAAMY,kFAEHT;AAFH,uFAKO,AAACd,4CAAI,WAAAwB,9IAGL,oDAAA,7CAACzB;AAHI,AAAA,IAAA0B,aAAAD;WAAA,AAAAE,4CAAAD,WAAA,IAAA,lEAAMnC;cAAN,AAAAoC,4CAAAD,WAAA,IAAA,rEAAWE;AAAX,AAAA,+FAAA,2CAAA,gFAAA,hIACGrC,uGAAa,AAACsC,gBAAMD,4EACD,gEAAA,hEAACE,+CAAOC,qBAAI,4CAAA,5CAAC9B,6GAAgB2B;2EAJxD,AAAA,wGAAiBb,hLACjB,mBAAA,nBAACV;;AAMR;;;wCAAA,xCAAM2B,wFAEHjB,QAAQkB;AAFX,AAGE,uBACK,+CAAA,WAAAC,1DAACxB,hBAEDrC;AAFA,AAAS,SAAK,CAAI4D,WAAQ,AAAA,oGAAAC,wBACZ,CAAGD,UAAQ,AAAA,kGAAAC;GAFzB,AAAA,wGAAiBnB;;AAKxB;;;uCAAA,vCAAMoB,sFAEHpB,QAAQkB;AAFX,AAGE,IAAMG,SAAO,AAACJ,sCAAkBjB,QAAQkB;AAAxC,AAAA,kDAAA,kEAAA,8JAAA,gLAAA,oOAAA,1jBACYA,2EACI,AAAA,mFAAOG,4EACN,AAAA,oGAAgBA,oFACZ,0BAAA,wHAAA,hIAAMA,QAAO,CAAGH,UAAQ,AAAA,oGAAgBG,iFAC7C,AAAA,gGAAcA;;AAMhC;;;qCAAA,rCAAMC,kFAEHC,MAAM7D;AAFT,AAGE,OAAC8D,6DAAYD,wDAAM,AAACE,yBAAa/D;;AAEnC;;;4CAAA,5CAAMgE,gGAEHH,MAAM7D;AAFT,AAGE,IAAMiE,SAAO,AAACL,mCAAeC,MAAM7D;AAAnC,AAAA,kDAAA,iHAAA,0HAAA,+GAAA,gHAAA,lYACmB,AAACkE,iCAAqBD,gFACtB,AAACE,0CAA8BF,+EAChC,AAACG,gCAAoBH,2EACvB,AAACI,qCAAyBJ,yDACnC,AAACK,6BAAiBL;;AAE3B;;;;6CAAA,7CAAMM,kGAGHV,MAAMvB;AAHT,AAIE,IAAM2B,SAAO,AAACL,mCAAeC,MAAM,AAAA,iFAAMvB;IACnCkC,YAAU,8HAAA,uDAAA,rLAACC,qEAAoBR;AADrC,6FAGO,AAACzC,4CAAI,WAAAkD,pJAGL,0BAAA,nBAAC9C;AAHI,AAAA,IAAA+C,aAAAD;WAAA,AAAAxB,4CAAAyB,WAAA,IAAA,lEAAMC;YAAN,AAAA1B,4CAAAyB,WAAA,IAAA,nEAAWE;AAAX,AACE,IAAMC,aAAW,AAACpB,qCAAiBpB,QAAQsC;AAA3C,AACE,gEAAA,zDAAClC,8CAAMoC,+EAAyBD;GAHzCL;;AAUT;;;;2CAAA,3CAAMO,8FAGHlB,MAAM7D,IAAIgF,UAAUC;AAHvB,AAIE,IAAMhB,uHAAY,AAACH,6DAAYD,wDACA,AAACE,yBAAa/D,KACd,iHAAA,oEAAA,gEAAA,rPAACkF,jQACd,gDAAA,hDAAChE;IACbiE,YAAU,GAAS,aAAA,ZAAKF;AAJ9B,AAOO,OAACzD,4CAAI,WAAA6D;AAAA,AAAA,IAAAC,aAAAD;IAAAC,iBAAA,AAAA9F,4BAAA8F;aAAA,AAAA7F,4CAAA6F,eAAA,pEAAaC;iBAAb,AAAA9F,4CAAA6F,eAAA,xEAAoBrB;AAApB,AAAA,kDAAA,+DAAA,PACWsB,4EACM,gBAAA,iDAEK,4CAAA,WAAAE,vDAACjE,jDACDkE,hBACAtC;AAFA,AAAM,QAAAqC,mBAAWN;yHAJvC,fAEsBlB,vGACA,6CAAA,7CAACuB,oMAID,CAAGP,YACA,gBAAA,iDAEK,4CAAA,WAAAU,vDAACnE,jDACDkE,hBACAtC;AAFA,AAAM,QAAAuC,mBAAWR;0GAFjBlB,vGACA,6CAAA,7CAACuB;gDAXpCvB,7CACA,AAACmB,mCAAuBJ;;AAmBjC;;;;;;;;;qCAAA,rCAAMY,kFAQH/B,MAAMvB,QAAQuD,gBAAgBb;AARjC,AASE,IAAMc,cAAY,mJAAA,nJAACf,yCAAqBlB,MAAM,AAAA,iFAAMvB,SAAS0C;IACvDe,YAAU,CAAG,gEAAA,hEAAC1C,+CAAOC,qBAAI,4CAAA,5CAAC9B,0HAAuBsE,gBACpC,iBAAAE,kBAAA;IAAAC,kBAAO,AAAC7C,gBAAM0C;AAAd,AAAA,SAAAE,kBAAAC,mBAAAD,kBAAAC;;IACbC,UAAQ,CAAA,OAAA;IACRC,UAAQ,CAAA,QAAA;IACRC,UAAQ,CAAA,CAAA,MAAA,UAAA;AALd,AAAA,kDAAA,wFAAA,VAMsBL,sEACT,yBAAA,oDAAA,yBAAA,0DAAA,yBAAA,qDAAA,AAAA,5OACE,CAAGA,YAAUG,gEACb,CAAGH,YAAUI,sEACb,CAAGJ,YAAUK;IAV5B,yEAYmB,yBAAA,mCAAA,yBAAA,yCAAA,yBAAA,6DAAA,AAAA,lNACE,CAAGL,YAAUG,+CAGb,CAAGH,YAAUI,qDAGb,CAAGJ,YAAUK;;;AAUpC;;;wCAAA,xCAAMC,wFAEHxC,MAAMyC;AAFT,AAGE,IAAMC,YAAU,4CAAA,WAAAC,vDAAChF;AAAD,AAAM,uHAAA,mDAAAgF,nKAAC9D,8CAAM,gDAAA8D,hDAACxC,0CAAsBH;GAE/ByC;AAFrB,AAAA,kDAAA,yEAAA,VAGcC,+EACI,gEAAA,WAAAE,3EAACC,8CAAMC;AAAP,AAAgB,sDAAAF,iBAAA,mFAAA,wEAAA,qEAAA,hSAACG;cAJnC,XAI2EL,mFACxD,gEAAA,WAAAM,3EAACH,8CAAMI;AAAP,AAAgB,sDAAAD,iBAAA,mFAAA,wEAAA,qEAAA,hSAACD;cALpC,XAK4EL,qEAChE,gEAAA,WAAAQ,3EAACL,8CAAMC;AAAP,AAAgB,QAAG,+CAAAI,iBAAA,mFAAA,iDAAA,0EAAA,9QAACH,qRACD,+CAAAG,iBAAA,mFAAA,iDAAA,4EAAA,hRAACH;GACbL;;AAMrB","names":["observatory.process/ProcessState","observatory.process/MemoryRegion","observatory.process/Process","var_args","args__5732__auto__","len__5726__auto__","i__5727__auto__","argseq__5733__auto__","cljs.core/IndexedSeq","observatory.process/make-process","p__12738","map__12739","cljs.core/--destructure-map","cljs.core.get","seq12735","G__12736","cljs.core/first","cljs.core/next","G__12737","self__5711__auto__","pid","name","ppid","exe-path","cmdline","state","user","cpu-percent","memory-bytes","threads","handles","observatory.process/make-memory-region","start-address","size-bytes","type","protection","observatory.process/processes-by-cpu","processes","cljs.core.sort_by","cljs.core/>","observatory.process/processes-by-memory","observatory.process/process-tree","by-pid","cljs.core.into","cljs.core.map","cljs.core.juxt","cljs.core/identity","children-map","cljs.core/group-by","proc","cljs.core.mapv","build-node","p1__12740#","cljs.core.filter","observatory.process/flatten-tree","tree","p__12745","map__12746","process","children","depth","cljs.core/cons","cljs.core.assoc","p1__12741#","cljs.core.mapcat","flatten-node","p1__12742#","observatory.process/memory-by-type","p__12747","vec__12748","cljs.core.nth","regions","cljs.core/count","cljs.core.reduce","cljs.core/+","observatory.process/address-to-region","address","p1__12751#","observatory.process/annotate-address","region","observatory.process/process-events","trace","observatory.trace.query","observatory.trace/by-pid","observatory.process/process-cache-summary","events","observatory.trace/cache-hit-rate","observatory.trace/cache-hit-rate-by-level","observatory.trace/hot-addresses","observatory.trace/page-fault-summary","observatory.trace/io-summary","observatory.process/process-memory-heatmap","addresses","observatory.trace.hot_addresses","p__12752","vec__12753","addr","count","annotation","observatory.process/estimate-working-set","window-ns","line-size","observatory.trace.by_type","line-mask","observatory.trace/timeline-buckets","p__12758","map__12759","bucket","cljs.core.keep","p1__12756#","cljs.core.distinct","p1__12757#","observatory.process/cache-pressure","cache-hierarchy","working-set","avg-bytes","x__5087__auto__","y__5088__auto__","l1-size","l2-size","l3-size","observatory.process/compare-processes","pids","summaries","p1__12760#","p1__12761#","cljs.core.apply","cljs.core/max-key","cljs.core.get_in","p1__12762#","cljs.core/min-key","p1__12763#"],"sourcesContent":["(ns observatory.process\n  \"Process-centric view of system activity.\n\n   This ties together:\n   - Process information (Task Manager view)\n   - Process memory layout (address space)\n   - Process I/O activity\n   - Process cache behavior\n\n   Connects the 'taskman' origin to the hardware observatory.\"\n  (:require [observatory.schema :as schema]\n            [observatory.trace :as trace]\n            [observatory.cache :as cache]))\n\n;; =============================================================================\n;; Process Schema\n;; =============================================================================\n\n(def ProcessState\n  [:enum :running :sleeping :stopped :zombie])\n\n(def MemoryRegion\n  \"A region of process virtual address space\"\n  [:map\n   [:start-address :int]\n   [:end-address :int]\n   [:size-bytes :int]\n   [:protection [:enum :read :write :execute :read-write :read-execute :all]]\n   [:type [:enum :code :data :heap :stack :mapped-file :shared]]\n   [:mapped-file {:optional true} :string]  ; Path if memory-mapped file\n   [:resident-bytes {:optional true} :int]]) ; Actually in RAM\n\n(def Process\n  [:map\n   [:pid :int]\n   [:ppid {:optional true} :int]           ; Parent PID\n   [:name :string]\n   [:exe-path {:optional true} :string]\n   [:cmdline {:optional true} :string]\n   [:state ProcessState]\n   [:user {:optional true} :string]\n   [:cpu-percent :double]\n   [:memory-bytes :int]\n   [:threads :int]\n   [:handles {:optional true} :int]        ; Windows handle count\n   [:start-time {:optional true} :string]\n   [:memory-regions {:optional true} [:vector MemoryRegion]]])\n\n;; =============================================================================\n;; Process Data Structures\n;; =============================================================================\n\n(defn make-process\n  \"Create a process record\"\n  [pid name & {:keys [ppid exe-path cmdline state user\n                      cpu-percent memory-bytes threads handles]\n               :or {state :running\n                    cpu-percent 0.0\n                    memory-bytes 0\n                    threads 1}}]\n  {:pid pid\n   :ppid ppid\n   :name name\n   :exe-path exe-path\n   :cmdline cmdline\n   :state state\n   :user user\n   :cpu-percent cpu-percent\n   :memory-bytes memory-bytes\n   :threads threads\n   :handles handles\n   :memory-regions []})\n\n(defn make-memory-region\n  \"Create a memory region\"\n  [start-address size-bytes type protection]\n  {:start-address start-address\n   :end-address (+ start-address size-bytes)\n   :size-bytes size-bytes\n   :type type\n   :protection protection})\n\n;; =============================================================================\n;; Process List Operations\n;; =============================================================================\n\n(defn processes-by-cpu\n  \"Sort processes by CPU usage descending\"\n  [processes]\n  (sort-by :cpu-percent > processes))\n\n(defn processes-by-memory\n  \"Sort processes by memory usage descending\"\n  [processes]\n  (sort-by :memory-bytes > processes))\n\n(defn process-tree\n  \"Build process tree from flat list.\n   Returns map of {pid -> {:process ... :children [...]}}\"\n  [processes]\n  (let [by-pid (into {} (map (juxt :pid identity) processes))\n        children-map (group-by :ppid processes)]\n    (letfn [(build-node [proc]\n              {:process proc\n               :children (mapv build-node (get children-map (:pid proc) []))})]\n      (->> processes\n           (filter #(nil? (get by-pid (:ppid %))))  ; Root processes\n           (mapv build-node)))))\n\n(defn flatten-tree\n  \"Flatten process tree back to list with depth info\"\n  [tree]\n  (letfn [(flatten-node [{:keys [process children]} depth]\n            (cons (assoc process :depth depth)\n                  (mapcat #(flatten-node % (inc depth)) children)))]\n    (mapcat #(flatten-node % 0) tree)))\n\n;; =============================================================================\n;; Process Memory Analysis\n;; =============================================================================\n\n(defn memory-by-type\n  \"Summarize memory regions by type\"\n  [process]\n  (->> (:memory-regions process)\n       (group-by :type)\n       (map (fn [[type regions]]\n              [type {:count (count regions)\n                     :total-bytes (reduce + 0 (map :size-bytes regions))}]))\n       (into {})))\n\n(defn address-to-region\n  \"Find which memory region contains an address\"\n  [process address]\n  (->> (:memory-regions process)\n       (filter #(and (>= address (:start-address %))\n                     (< address (:end-address %))))\n       first))\n\n(defn annotate-address\n  \"Add region info to an address\"\n  [process address]\n  (let [region (address-to-region process address)]\n    {:address address\n     :region-type (:type region)\n     :region-start (:start-address region)\n     :offset-in-region (when region (- address (:start-address region)))\n     :mapped-file (:mapped-file region)}))\n\n;; =============================================================================\n;; Process-Trace Correlation\n;; =============================================================================\n\n(defn process-events\n  \"Get all trace events for a process\"\n  [trace pid]\n  (trace/query trace (trace/by-pid pid)))\n\n(defn process-cache-summary\n  \"Summarize cache behavior for a process\"\n  [trace pid]\n  (let [events (process-events trace pid)]\n    {:cache-hit-rate (trace/cache-hit-rate events)\n     :cache-by-level (trace/cache-hit-rate-by-level events)\n     :hot-addresses (trace/hot-addresses events)\n     :page-faults (trace/page-fault-summary events)\n     :io (trace/io-summary events)}))\n\n(defn process-memory-heatmap\n  \"Create heatmap of memory access frequency.\n   Returns map of {region-type -> [{:address :count}]}\"\n  [trace process]\n  (let [events (process-events trace (:pid process))\n        addresses (trace/hot-addresses events :top-n 100)]\n    (->> addresses\n         (map (fn [[addr count]]\n                (let [annotation (annotate-address process addr)]\n                  (assoc annotation :access-count count))))\n         (group-by :region-type))))\n\n;; =============================================================================\n;; Working Set Analysis\n;; =============================================================================\n\n(defn estimate-working-set\n  \"Estimate process working set from memory access trace.\n   Working set = unique cache lines accessed in time window.\"\n  [trace pid window-ns line-size]\n  (let [events (->> (trace/query trace\n                                 (trace/by-pid pid)\n                                 (trace/by-type :cache-access :cache-hit :cache-miss))\n                    (sort-by :timestamp))\n        line-mask (bit-not (dec line-size))]\n    (->> events\n         (trace/timeline-buckets window-ns)\n         (map (fn [{:keys [bucket events]}]\n                {:window bucket\n                 :unique-lines (->> events\n                                    (keep :address)\n                                    (map #(bit-and % line-mask))\n                                    distinct\n                                    count)\n                 :working-set-bytes (* line-size\n                                       (->> events\n                                            (keep :address)\n                                            (map #(bit-and % line-mask))\n                                            distinct\n                                            count))})))))\n\n;; =============================================================================\n;; Cache Pressure Analysis\n;; =============================================================================\n\n(defn cache-pressure\n  \"Analyze cache pressure for a process.\n\n   Returns assessment:\n   - :low - working set fits in L1\n   - :medium - working set fits in L2\n   - :high - working set fits in L3\n   - :thrashing - working set exceeds L3\"\n  [trace process cache-hierarchy window-ns]\n  (let [working-set (estimate-working-set trace (:pid process) window-ns 64)\n        avg-bytes (/ (reduce + 0 (map :working-set-bytes working-set))\n                     (max 1 (count working-set)))\n        l1-size (* 32 1024)    ; Typical L1\n        l2-size (* 256 1024)   ; Typical L2\n        l3-size (* 8 1024 1024)] ; Typical L3\n    {:working-set-bytes avg-bytes\n     :pressure (cond\n                 (< avg-bytes l1-size) :low\n                 (< avg-bytes l2-size) :medium\n                 (< avg-bytes l3-size) :high\n                 :else :thrashing)\n     :recommendation (cond\n                       (< avg-bytes l1-size)\n                       \"Working set fits in L1 - optimal\"\n\n                       (< avg-bytes l2-size)\n                       \"Working set fits in L2 - good locality\"\n\n                       (< avg-bytes l3-size)\n                       \"Working set fits in L3 - consider data layout optimization\"\n\n                       :else\n                       \"Working set exceeds L3 - memory-bound, consider reducing footprint\")}))\n\n;; =============================================================================\n;; Process Comparison\n;; =============================================================================\n\n(defn compare-processes\n  \"Compare cache behavior of multiple processes\"\n  [trace pids]\n  (let [summaries (map #(assoc (process-cache-summary trace %)\n                               :pid %)\n                       pids)]\n    {:processes summaries\n     :best-hit-rate (apply max-key #(get-in % [:cache-hit-rate :hit-rate] 0) summaries)\n     :worst-hit-rate (apply min-key #(get-in % [:cache-hit-rate :hit-rate] 1) summaries)\n     :most-io (apply max-key #(+ (get-in % [:io :read-bytes] 0)\n                                 (get-in % [:io :write-bytes] 0))\n                     summaries)}))\n\n;; =============================================================================\n;; REPL Exploration\n;; =============================================================================\n\n(comment\n  ;; Create some processes\n  (def chrome (make-process 1234 \"chrome.exe\"\n                            :memory-bytes (* 500 1024 1024)\n                            :cpu-percent 12.5\n                            :threads 45))\n\n  (def vscode (make-process 5678 \"code.exe\"\n                            :memory-bytes (* 800 1024 1024)\n                            :cpu-percent 5.2\n                            :threads 32))\n\n  ;; Add memory regions\n  (def chrome-with-mem\n    (assoc chrome :memory-regions\n           [(make-memory-region 0x7ff600000000 (* 50 1024 1024) :code :read-execute)\n            (make-memory-region 0x7ff650000000 (* 200 1024 1024) :heap :read-write)\n            (make-memory-region 0x7ff700000000 (* 100 1024 1024) :mapped-file :read)]))\n\n  ;; Analyze\n  (memory-by-type chrome-with-mem)\n  (annotate-address chrome-with-mem 0x7ff650001000)\n\n  ;; With trace data\n  (def test-trace\n    (trace/add-events\n     (trace/make-trace :target-pid 1234)\n     [{:timestamp 0 :type :cache-miss :pid 1234 :tid 1 :address 0x7ff650001000 :level :l1}\n      {:timestamp 10 :type :cache-hit :pid 1234 :tid 1 :address 0x7ff650001000 :level :l1}\n      {:timestamp 20 :type :cache-miss :pid 1234 :tid 1 :address 0x7ff650002000 :level :l1}]))\n\n  (process-cache-summary test-trace 1234)\n  )\n"]}