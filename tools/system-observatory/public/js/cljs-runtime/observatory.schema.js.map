{"version":3,"sources":["observatory/schema.cljc"],"mappings":"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","names":["observatory.schema/Address","observatory.schema/Byte","observatory.schema/Bytes","observatory.schema/Timestamp","observatory.schema/Pid","observatory.schema/Tid","observatory.schema/CacheType","observatory.schema/CacheLevel","observatory.schema/CacheInfo","observatory.schema/CpuCore","observatory.schema/CpuTopology","observatory.schema/MesiState","observatory.schema/CacheLine","observatory.schema/CacheWay","observatory.schema/CacheSet","observatory.schema/CacheState","observatory.schema/RamBank","observatory.schema/RamChannel","observatory.schema/RamTopology","observatory.schema/DiskType","observatory.schema/SsdPage","observatory.schema/SsdDie","observatory.schema/DiskInfo","observatory.schema/EventType","observatory.schema/BaseEvent","observatory.schema/PageFaultEvent","observatory.schema/CacheAccessEvent","observatory.schema/CacheEvictionEvent","observatory.schema/DiskIoEvent","observatory.schema/TraceEvent","observatory.schema/TraceMetadata","observatory.schema/Trace","observatory.schema/registry","cljs.core.merge","malli.core/default-schemas","malli.registry/set-default-registry!","var_args","G__21034","observatory.schema/generate","js/Error","schema","malli.generator.generate","opts","G__21036","observatory.schema/sample","malli.generator.sample","n"],"sourcesContent":["(ns observatory.schema\n  \"Pure data definitions for the System Observatory.\n\n   All schemas are data - can be inspected, transformed, generated from.\n   Using Malli for performance and better error messages than spec.\"\n  (:require [malli.core :as m]\n            [malli.registry :as mr]\n            [malli.generator :as mg]))\n\n;; =============================================================================\n;; Primitive Types\n;; =============================================================================\n\n(def Address\n  \"64-bit memory address\"\n  [:int {:min 0 :max 0xFFFFFFFFFFFFFFFF}])\n\n(def Byte\n  [:int {:min 0 :max 255}])\n\n(def Bytes\n  \"Raw byte sequence\"\n  [:vector Byte])\n\n(def Timestamp\n  \"Nanoseconds since trace start\"\n  [:int {:min 0}])\n\n(def Pid\n  \"Process ID\"\n  [:int {:min 0 :max 0xFFFFFFFF}])\n\n(def Tid\n  \"Thread ID\"\n  [:int {:min 0 :max 0xFFFFFFFF}])\n\n;; =============================================================================\n;; CPU Topology\n;; =============================================================================\n\n(def CacheType\n  [:enum :data :instruction :unified])\n\n(def CacheLevel\n  [:enum :l1 :l2 :l3])\n\n(def CacheInfo\n  \"Single cache in the hierarchy\"\n  [:map\n   [:level CacheLevel]\n   [:type CacheType]\n   [:size-kb :int]\n   [:line-size {:default 64} :int]\n   [:associativity :int]\n   [:sets :int]\n   [:shared-by-cores {:default 1} :int]])\n\n(def CpuCore\n  [:map\n   [:index :int]\n   [:physical-core :int]          ; Which physical core (for SMT)\n   [:caches [:vector CacheInfo]]])  ; Caches accessible to this core\n\n(def CpuTopology\n  [:map\n   [:vendor :string]\n   [:brand :string]\n   [:physical-cores :int]\n   [:logical-cores :int]\n   [:cores [:vector CpuCore]]\n   [:caches [:vector CacheInfo]]])  ; Deduplicated cache list\n\n;; =============================================================================\n;; Cache State (Simulation)\n;; =============================================================================\n\n(def MesiState\n  \"Cache coherency state\"\n  [:enum :modified :exclusive :shared :invalid])\n\n(def CacheLine\n  \"A single cache line (typically 64 bytes)\"\n  [:map\n   [:tag Address]                 ; Upper bits of address\n   [:data Bytes]                  ; The actual data (64 bytes typical)\n   [:state MesiState]\n   [:last-access Timestamp]\n   [:access-count :int]])\n\n(def CacheWay\n  \"One way in a set-associative cache\"\n  [:map\n   [:index :int]\n   [:line [:maybe CacheLine]]])   ; nil if empty\n\n(def CacheSet\n  \"A set containing N ways\"\n  [:map\n   [:index :int]\n   [:ways [:vector CacheWay]]\n   [:lru-order [:vector :int]]])  ; Way indices in LRU order (head = victim)\n\n(def CacheState\n  \"Complete state of one cache level\"\n  [:map\n   [:level CacheLevel]\n   [:type CacheType]\n   [:config CacheInfo]\n   [:sets [:vector CacheSet]]\n   [:stats [:map\n            [:hits :int]\n            [:misses :int]\n            [:evictions :int]]]])\n\n;; =============================================================================\n;; Memory (RAM)\n;; =============================================================================\n\n(def RamBank\n  [:map\n   [:index :int]\n   [:rows :int]\n   [:columns :int]\n   [:open-row [:maybe :int]]])    ; Currently activated row (row buffer)\n\n(def RamChannel\n  [:map\n   [:index :int]\n   [:banks [:vector RamBank]]])\n\n(def RamTopology\n  [:map\n   [:total-bytes :int]\n   [:channels [:vector RamChannel]]])\n\n;; =============================================================================\n;; Disk\n;; =============================================================================\n\n(def DiskType\n  [:enum :hdd :ssd :nvme])\n\n(def SsdPage\n  [:map\n   [:block :int]\n   [:page :int]\n   [:state [:enum :free :valid :invalid]]])\n\n(def SsdDie\n  [:map\n   [:index :int]\n   [:blocks :int]\n   [:pages-per-block :int]])\n\n(def DiskInfo\n  [:map\n   [:name :string]\n   [:type DiskType]\n   [:capacity-bytes :int]\n   ;; HDD-specific\n   [:platters {:optional true} :int]\n   [:rpm {:optional true} :int]\n   ;; SSD-specific\n   [:dies {:optional true} [:vector SsdDie]]])\n\n;; =============================================================================\n;; Trace Events\n;; =============================================================================\n\n(def EventType\n  [:enum\n   ;; CPU events\n   :instruction-sample\n   :context-switch\n   :branch-mispredict\n   ;; Memory events\n   :page-fault\n   :page-fault-hard      ; Required disk I/O\n   :working-set-change\n   ;; Cache events (from simulation or PMC)\n   :cache-access\n   :cache-hit\n   :cache-miss\n   :cache-eviction\n   ;; Disk events\n   :disk-read\n   :disk-write\n   :disk-flush])\n\n(def BaseEvent\n  \"Common fields for all events\"\n  [:map\n   [:timestamp Timestamp]\n   [:type EventType]\n   [:pid Pid]\n   [:tid Tid]])\n\n(def PageFaultEvent\n  [:merge BaseEvent\n   [:map\n    [:type [:= :page-fault]]\n    [:address Address]\n    [:is-write :boolean]\n    [:is-hard :boolean]]])        ; Required disk I/O\n\n(def CacheAccessEvent\n  [:merge BaseEvent\n   [:map\n    [:type [:enum :cache-access :cache-hit :cache-miss]]\n    [:address Address]\n    [:level CacheLevel]\n    [:set-index :int]\n    [:way-index [:maybe :int]]    ; nil for miss\n    [:is-write :boolean]]])\n\n(def CacheEvictionEvent\n  [:merge BaseEvent\n   [:map\n    [:type [:= :cache-eviction]]\n    [:level CacheLevel]\n    [:set-index :int]\n    [:way-index :int]\n    [:evicted-address Address]\n    [:new-address Address]\n    [:was-dirty :boolean]]])\n\n(def DiskIoEvent\n  [:merge BaseEvent\n   [:map\n    [:type [:enum :disk-read :disk-write :disk-flush]]\n    [:disk-index :int]\n    [:offset-bytes :int]\n    [:size-bytes :int]\n    [:latency-ns :int]\n    [:queue-depth :int]]])\n\n(def TraceEvent\n  \"Union of all event types\"\n  [:or\n   PageFaultEvent\n   CacheAccessEvent\n   CacheEvictionEvent\n   DiskIoEvent])\n\n;; =============================================================================\n;; Trace Container\n;; =============================================================================\n\n(def TraceMetadata\n  [:map\n   [:start-time :string]          ; ISO-8601\n   [:duration-ns :int]\n   [:event-count :int]\n   [:target-pid [:maybe Pid]]\n   [:cpu-topology CpuTopology]\n   [:ram-topology [:maybe RamTopology]]\n   [:disks [:vector DiskInfo]]])\n\n(def Trace\n  \"A complete trace session\"\n  [:map\n   [:metadata TraceMetadata]\n   [:events [:vector TraceEvent]]])\n\n;; =============================================================================\n;; Registry - make all schemas available by keyword\n;; =============================================================================\n\n(def registry\n  (merge\n   (m/default-schemas)\n   {:observatory/address Address\n    :observatory/bytes Bytes\n    :observatory/timestamp Timestamp\n    :observatory/pid Pid\n    :observatory/tid Tid\n    :observatory/cache-type CacheType\n    :observatory/cache-level CacheLevel\n    :observatory/cache-info CacheInfo\n    :observatory/cache-line CacheLine\n    :observatory/cache-way CacheWay\n    :observatory/cache-set CacheSet\n    :observatory/cache-state CacheState\n    :observatory/cpu-topology CpuTopology\n    :observatory/ram-topology RamTopology\n    :observatory/disk-info DiskInfo\n    :observatory/event-type EventType\n    :observatory/trace-event TraceEvent\n    :observatory/trace Trace}))\n\n(mr/set-default-registry! registry)\n\n;; =============================================================================\n;; Generators (for testing and simulation)\n;; =============================================================================\n\n(defn generate\n  \"Generate sample data for a schema\"\n  ([schema] (mg/generate schema))\n  ([schema opts] (mg/generate schema opts)))\n\n(defn sample\n  \"Generate multiple samples\"\n  ([schema] (mg/sample schema))\n  ([schema n] (mg/sample schema {:size n})))\n\n(comment\n  ;; REPL exploration\n  (generate CacheInfo)\n  (generate CacheAccessEvent)\n  (sample TraceEvent 5)\n\n  ;; Validate data\n  (m/validate CacheInfo {:level :l1\n                         :type :data\n                         :size-kb 32\n                         :line-size 64\n                         :associativity 8\n                         :sets 64\n                         :shared-by-cores 1})\n  )\n"]}